/**
 * 工具前端展示配置
 *
 * 数据驱动：
 * 1. 从 .testagent/settings.json 读取全局 toolDisplay 配置
 * 2. 从 .testagent/skills/*/settings.json 读取各技能的 toolDisplay 配置
 * 3. 合并所有配置，技能配置覆盖全局配置
 *
 * 日志中仍保留原始英文名称，仅 SSE 推送给前端时做转换/过滤。
 */

import { readFileSync, readdirSync, existsSync } from 'fs';
import { dirname, resolve, join } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

/** 硬编码默认显示名 */
const DEFAULT_DISPLAY_NAMES: Record<string, string> = {
  // ===== 框架内置工具 =====
  reset_equipped_tools: '重置工具组',
  equip_tool_group: '激活工具组',
  list_equipped_tools: '列出已激活工具',

  // ===== 基础工具 (Base Tools) =====
  execute_shell: '执行命令',
  read_file: '读取文件',
  write_file: '写入文件',
  edit_file: '编辑文件',
  glob_files: '搜索文件',
  grep_files: '搜索内容',
  web_fetch: '获取网页',
  list_uploaded_files: '列出上传文件',

  // ===== MCP 工具 =====
  read_document: '读取文档',
  read_image: '读取图片',

  // ===== API 测试技能工具 (默认值，可被技能配置覆盖) =====
  extract_api_spec: '提取接口规范',
  validate_api_spec: '校验接口规范',
  generate_positive_cases: '生成正向用例',
  generate_negative_cases: '生成异常用例',
  generate_security_cases: '生成安全用例',
  apply_business_rules: '应用业务规则',
  execute_api_test: '执行接口测试',
  validate_response: '校验响应结果',
  capture_metrics: '采集性能指标',
  generate_test_report: '生成测试报告',
  diagnose_failures: '诊断失败原因',
  suggest_improvements: '提供改进建议',
};

/** 硬编码默认隐藏工具 */
const DEFAULT_HIDDEN_TOOLS: readonly string[] = [
  'reset_equipped_tools',
  'equip_tool_group',
  'list_equipped_tools',
];

interface ToolCategory {
  displayName: string;
  tools: string[];
}

interface SkillToolDisplay {
  names: Record<string, string>;
  categories: Record<string, ToolCategory>;
}

interface ToolDisplayConfig {
  names: Record<string, string>;
  hidden: ReadonlySet<string>;
  categories: Record<string, ToolCategory>;
  skills: Record<string, SkillToolDisplay>;
}

/**
 * Load skill-level settings from .testagent/skills/*/settings.json
 */
function loadSkillSettings(skillsDir: string): Record<string, SkillToolDisplay> {
  const skillSettings: Record<string, SkillToolDisplay> = {};

  if (!existsSync(skillsDir)) {
    return skillSettings;
  }

  try {
    const skillDirs = readdirSync(skillsDir, { withFileTypes: true })
      .filter((d) => d.isDirectory())
      .map((d) => d.name);

    for (const skillName of skillDirs) {
      const settingsPath = join(skillsDir, skillName, 'settings.json');
      if (existsSync(settingsPath)) {
        try {
          const raw = readFileSync(settingsPath, 'utf-8');
          const settings = JSON.parse(raw);
          const toolDisplay = settings?.toolDisplay;

          if (toolDisplay) {
            skillSettings[skillName] = {
              names: toolDisplay.names ?? {},
              categories: toolDisplay.categories ?? {},
            };
          }
        } catch {
          // Ignore invalid skill settings
        }
      }
    }
  } catch {
    // Ignore errors reading skill directories
  }

  return skillSettings;
}

function loadToolDisplayConfig(): ToolDisplayConfig {
  const testagentDir = resolve(__dirname, '..', '..', '..', '.testagent');
  const settingsPath = resolve(testagentDir, 'settings.json');
  const skillsDir = resolve(testagentDir, 'skills');

  // Load skill settings
  const skills = loadSkillSettings(skillsDir);

  try {
    const raw = readFileSync(settingsPath, 'utf-8');
    const settings = JSON.parse(raw);
    const toolDisplay = settings?.toolDisplay;

    if (!toolDisplay) {
      // Merge skill names into default names
      const mergedNames = { ...DEFAULT_DISPLAY_NAMES };
      for (const skillToolDisplay of Object.values(skills)) {
        Object.assign(mergedNames, skillToolDisplay.names);
      }

      return {
        names: mergedNames,
        hidden: new Set(DEFAULT_HIDDEN_TOOLS),
        categories: {},
        skills,
      };
    }

    // Start with defaults and global config
    const names: Record<string, string> = {
      ...DEFAULT_DISPLAY_NAMES,
      ...(toolDisplay.names ?? {}),
    };

    // Merge all skill names into global names
    for (const skillToolDisplay of Object.values(skills)) {
      Object.assign(names, skillToolDisplay.names);
    }

    const hiddenList: string[] = Array.isArray(toolDisplay.hidden)
      ? toolDisplay.hidden
      : [...DEFAULT_HIDDEN_TOOLS];

    const categories: Record<string, ToolCategory> = toolDisplay.categories ?? {};

    return { names, hidden: new Set(hiddenList), categories, skills };
  } catch {
    // Merge skill names into default names
    const mergedNames = { ...DEFAULT_DISPLAY_NAMES };
    for (const skillToolDisplay of Object.values(skills)) {
      Object.assign(mergedNames, skillToolDisplay.names);
    }

    return {
      names: mergedNames,
      hidden: new Set(DEFAULT_HIDDEN_TOOLS),
      categories: {},
      skills,
    };
  }
}

let config = loadToolDisplayConfig();

/** 导出显示名映射（兼容旧代码引用） */
export const toolDisplayNames: Record<string, string> = config.names;

/** 导出隐藏工具集合（兼容旧代码引用） */
export const hiddenTools: ReadonlySet<string> = config.hidden;

/** 导出工具分类（全局） */
export const toolCategories: Record<string, ToolCategory> = config.categories;

/** 导出技能级别工具配置 */
export const skillToolSettings: Record<string, SkillToolDisplay> = config.skills;

/**
 * 获取工具的前端显示名称。
 * 若未在映射表中定义，则原样返回。
 */
export function getToolDisplayName(name: string): string {
  return config.names[name] ?? name;
}

/**
 * 判断工具是否应对前端隐藏。
 */
export function isToolHidden(name: string): boolean {
  return config.hidden.has(name);
}

/**
 * 获取完整的工具显示配置（用于 API 返回给前端）
 */
export function getToolDisplayConfig(): {
  names: Record<string, string>;
  categories: Record<string, ToolCategory>;
  skills: Record<string, SkillToolDisplay>;
} {
  return {
    names: config.names,
    categories: config.categories,
    skills: config.skills,
  };
}

/**
 * 重新加载 toolDisplay 配置（支持热更新场景）。
 */
export function reloadToolDisplayConfig(): void {
  config = loadToolDisplayConfig();
  // 更新导出引用
  Object.keys(toolDisplayNames).forEach((k) => delete toolDisplayNames[k]);
  Object.assign(toolDisplayNames, config.names);

  Object.keys(toolCategories).forEach((k) => delete toolCategories[k]);
  Object.assign(toolCategories, config.categories);

  Object.keys(skillToolSettings).forEach((k) => delete skillToolSettings[k]);
  Object.assign(skillToolSettings, config.skills);
}
